<script>
    let calculationHistory = [];
    let debounceTimeout;

    function calculateROI() {
        // Obter valores dos inputs
        const projectName = document.getElementById('projectName').value.trim() || 'Sem nome';
        const initialInvestment = parseFloat(document.getElementById('initialInvestment').value) || 0;
        const totalRevenue = parseFloat(document.getElementById('totalRevenue').value) || 0;
        const operationalCosts = parseFloat(document.getElementById('operationalCosts').value) || 0;
        const timePeriod = parseFloat(document.getElementById('timePeriod').value) || 1;

        // Valida√ß√µes
        if (initialInvestment <= 0) {
            alert('Por favor, insira um valor v√°lido para o investimento inicial.');
            return;
        }

        // C√°lculos
        const netRevenue = totalRevenue - operationalCosts;
        const netProfit = netRevenue - initialInvestment;
        const roiPercentage = ((netProfit / initialInvestment) * 100).toFixed(2);

        let paybackPeriod = '--';
        if (netRevenue > 0) {
            paybackPeriod = (initialInvestment / (netRevenue / timePeriod)).toFixed(1);
        }

        // Atualizar resultados na tela
        const roiEl = document.getElementById('roiPercentage');
        roiEl.textContent = roiPercentage + '%';
        roiEl.className = 'result-value ' + (roiPercentage >= 0 ? 'roi-positive' : 'roi-negative');

        document.getElementById('netProfit').textContent = 'R$ ' + netProfit.toLocaleString('pt-BR', { minimumFractionDigits: 2 });
        document.getElementById('paybackPeriod').textContent = paybackPeriod + (paybackPeriod !== '--' ? ' meses' : '');

        // Interpreta√ß√£o dos resultados
        let interpretation = '';
        if (roiPercentage > 20) {
            interpretation = 'üéâ <strong>Excelente ROI!</strong> Seu investimento est√° gerando retornos muito bons. ROI acima de 20% √© considerado excelente na maioria dos setores.';
        } else if (roiPercentage > 10) {
            interpretation = 'üëç <strong>Bom ROI!</strong> Seu investimento est√° apresentando retornos satisfat√≥rios. Um ROI entre 10-20% √© considerado bom.';
        } else if (roiPercentage > 0) {
            interpretation = '‚ö†Ô∏è <strong>ROI Positivo, mas baixo.</strong> O investimento est√° gerando lucro, mas voc√™ pode buscar formas de otimizar o retorno.';
        } else {
            interpretation = '‚ùå <strong>ROI Negativo!</strong> O investimento est√° gerando preju√≠zo. Revise sua estrat√©gia ou considere alternativas.';
        }

        document.getElementById('interpretation').innerHTML = '<h3>üí° Interpreta√ß√£o dos Resultados</h3><p>' + interpretation + '</p>';

        // Adicionar ao hist√≥rico
        const calculation = {
            project: projectName,
            investment: initialInvestment,
            revenue: totalRevenue,
            roi: roiPercentage,
            profit: netProfit,
            date: new Date().toLocaleDateString('pt-BR')
        };

        calculationHistory.unshift(calculation);
        updateHistoryTable();
    }

    function updateHistoryTable() {
        const tbody = document.getElementById('historyTable');

        if (calculationHistory.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #7f8c8d;">Nenhum c√°lculo realizado ainda</td></tr>';
            return;
        }

        tbody.innerHTML = '';
        calculationHistory.slice(0, 10).forEach(calc => {
            const row = tbody.insertRow();
            row.innerHTML = `
                <td>${calc.project}</td>
                <td>R$ ${calc.investment.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
                <td>R$ ${calc.revenue.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
                <td class="${calc.roi >= 0 ? 'roi-positive' : 'roi-negative'}">${calc.roi}%</td>
                <td>${calc.date}</td>
            `;
        });
    }

    function exportToCSV() {
        if (calculationHistory.length === 0) {
            alert('Nenhum dado para exportar!');
            return;
        }

        let csv = 'Projeto,Investimento,Receita,ROI,Lucro,Data\n';
        calculationHistory.forEach(calc => {
            csv += `"${calc.project}",${calc.investment},${calc.revenue},${calc.roi},${calc.profit},"${calc.date}"\n`;
        });

        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', 'historico_roi.csv');
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // Auto-c√°lculo com debounce
    document.addEventListener('DOMContentLoaded', function () {
        const inputs = document.querySelectorAll('input[type="number"]');
        inputs.forEach(input => {
            input.addEventListener('input', function () {
                clearTimeout(debounceTimeout);
                debounceTimeout = setTimeout(calculateROI, 1000);
            });
        });
    });
</script>
